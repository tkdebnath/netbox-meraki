{% extends 'netbox_meraki/base.html' %}

{% block page_content %}
<div class="row">
    <div class="col-md-12">
        <h1>Sync Log Details</h1>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <strong>Synchronization Information</strong>
            </div>
            <div class="card-body">
                <table class="table">
                    <tbody>
                        <tr>
                            <th>Timestamp:</th>
                            <td>{{ sync_log.timestamp }}</td>
                        </tr>
                        <tr>
                            <th>Status:</th>
                            <td>
                                {% if sync_log.status == 'success' %}
                                    <span class="badge bg-success">{{ sync_log.status }}</span>
                                {% elif sync_log.status == 'partial' %}
                                    <span class="badge bg-warning">{{ sync_log.status }}</span>
                                {% elif sync_log.status == 'failed' %}
                                    <span class="badge bg-danger">{{ sync_log.status }}</span>
                                {% elif sync_log.status == 'running' %}
                                    <span class="badge bg-primary">{{ sync_log.status }}</span>
                                {% else %}
                                    <span class="badge bg-info">{{ sync_log.status }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% if sync_log.status == 'running' %}
                        <tr>
                            <th>Current Operation:</th>
                            <td id="current-operation">{{ sync_log.current_operation }}</td>
                        </tr>
                        <tr>
                            <th>Progress:</th>
                            <td>
                                <div class="progress">
                                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" 
                                         style="width: {{ sync_log.progress_percent }}%"
                                         aria-valuenow="{{ sync_log.progress_percent }}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        <span id="progress-text">{{ sync_log.progress_percent }}%</span>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>Duration:</th>
                            <td>
                                {% if sync_log.duration_seconds %}
                                    {{ sync_log.duration_seconds|floatformat:2 }} seconds
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Message:</th>
                            <td>{{ sync_log.message }}</td>
                        </tr>
                        {% if sync_log.cancel_requested %}
                        <tr>
                            <th>Cancellation:</th>
                            <td><span class="badge bg-warning">Cancellation Requested at {{ sync_log.cancelled_at }}</span></td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <strong>Synchronization Statistics</strong>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2">
                        <div class="text-center">
                            <h3>{{ sync_log.organizations_synced }}</h3>
                            <p class="text-muted">Organizations</p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center">
                            <h3>{{ sync_log.networks_synced }}</h3>
                            <p class="text-muted">Networks</p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center">
                            <h3>{{ sync_log.devices_synced }}</h3>
                            <p class="text-muted">Devices</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h3>{{ sync_log.vlans_synced }}</h3>
                            <p class="text-muted">VLANs</p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center">
                            <h3>{{ sync_log.prefixes_synced }}</h3>
                            <p class="text-muted">Prefixes</p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center">
                            <h3>{{ sync_log.ssids_synced }}</h3>
                            <p class="text-muted">SSIDs</p>
                        </div>
                    </div>
                </div>
                {% if sync_log.deleted_sites or sync_log.deleted_devices or sync_log.deleted_vlans or sync_log.deleted_prefixes or sync_log.updated_prefixes %}
                <hr>
                <h5>Cleanup & Updates</h5>
                <div class="row mt-3">
                    <div class="col-md-2">
                        <div class="text-center">
                            <h4 class="text-warning">{{ sync_log.deleted_sites }}</h4>
                            <p class="text-muted">Sites Deleted</p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center">
                            <h4 class="text-warning">{{ sync_log.deleted_devices }}</h4>
                            <p class="text-muted">Devices Deleted</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-warning">{{ sync_log.deleted_vlans }}</h4>
                            <p class="text-muted">VLANs Deleted</p>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center">
                            <h4 class="text-warning">{{ sync_log.deleted_prefixes }}</h4>
                            <p class="text-muted">Prefixes Deleted</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-info">{{ sync_log.updated_prefixes }}</h4>
                            <p class="text-muted">Prefix Sites Changed</p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if sync_log.errors %}
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <strong>Errors</strong>
            </div>
            <div class="card-body">
                <ul>
                    {% for error in sync_log.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if sync_log.progress_logs %}
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Live Progress Logs</strong>
                <div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="auto-scroll-toggle" 
                               {% if sync_log.status == 'running' %}checked{% endif %}
                               onchange="toggleAutoScroll()">
                        <label class="form-check-label" for="auto-scroll-toggle">
                            Enable Live Scrolling (2s)
                        </label>
                    </div>
                    {% if sync_log.status == 'running' %}
                    <button id="auto-refresh-toggle" class="btn btn-sm btn-primary" onclick="toggleAutoRefresh()">
                        <i class="mdi mdi-pause"></i> Pause Auto-Refresh
                    </button>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div id="progress-logs" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.9em; background-color: #f8f9fa; padding: 15px; border-radius: 4px;">
                    {% for log in sync_log.progress_logs %}
                    <div class="log-entry">
                        <span class="text-muted">[{{ log.timestamp|slice:":19" }}]</span>
                        {% if log.level == 'error' %}
                            <span class="badge bg-danger">ERROR</span>
                        {% elif log.level == 'warning' %}
                            <span class="badge bg-warning">WARN</span>
                        {% else %}
                            <span class="badge bg-info">INFO</span>
                        {% endif %}
                        <span>{{ log.message }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row mt-4">
    <div class="col-md-12">
        <a href="{% url 'plugins:netbox_meraki:dashboard' %}" class="btn btn-secondary">
            Back to Dashboard
        </a>
        {% if sync_log.status == 'running' and not sync_log.cancel_requested %}
        <button id="cancel-sync-btn" class="btn btn-warning" onclick="cancelSync()">
            <i class="mdi mdi-cancel"></i> Cancel Sync
        </button>
        {% endif %}
    </div>
</div>

{% if sync_log.status == 'running' %}
<script>
let autoRefresh = true;
let autoScroll = true;
let refreshInterval;

function toggleAutoScroll() {
    const checkbox = document.getElementById('auto-scroll-toggle');
    autoScroll = checkbox.checked;
    
    if (autoScroll) {
        if (!refreshInterval) {
            startAutoRefresh();
        }
    } else {
        if (refreshInterval && !autoRefresh) {
            stopAutoRefresh();
        }
    }
}

function toggleAutoRefresh() {
    autoRefresh = !autoRefresh;
    const btn = document.getElementById('auto-refresh-toggle');
    if (autoRefresh) {
        btn.innerHTML = '<i class="mdi mdi-pause"></i> Pause Auto-Refresh';
        startAutoRefresh();
    } else {
        btn.innerHTML = '<i class="mdi mdi-play"></i> Resume Auto-Refresh';
        if (!autoScroll) {
            stopAutoRefresh();
        }
    }
}

function startAutoRefresh() {
    if (!refreshInterval) {
        refreshInterval = setInterval(fetchProgress, 2000);  // Refresh every 2 seconds
    }
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

function fetchProgress() {
    fetch('{% url "plugins:netbox_meraki:sync_progress_api" sync_log.id %}')
        .then(response => response.json())
        .then(data => {
            // Update progress bar
            if (data.progress_percent !== undefined) {
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                if (progressBar && progressText) {
                    progressBar.style.width = data.progress_percent + '%';
                    progressBar.setAttribute('aria-valuenow', data.progress_percent);
                    progressText.textContent = data.progress_percent + '%';
                }
            }
            
            // Update current operation
            if (data.current_operation) {
                const opElement = document.getElementById('current-operation');
                if (opElement) {
                    opElement.textContent = data.current_operation;
                }
            }
            
            // Update progress logs
            if (data.progress_logs && data.progress_logs.length > 0) {
                const logsContainer = document.getElementById('progress-logs');
                if (logsContainer) {
                    logsContainer.innerHTML = '';
                    data.progress_logs.forEach(log => {
                        const logEntry = document.createElement('div');
                        logEntry.className = 'log-entry';
                        
                        const timestamp = log.timestamp.substring(0, 19);
                        const levelBadge = log.level === 'error' ? 
                            '<span class="badge bg-danger">ERROR</span>' :
                            log.level === 'warning' ?
                            '<span class="badge bg-warning">WARN</span>' :
                            '<span class="badge bg-info">INFO</span>';
                        
                        logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${levelBadge} <span>${log.message}</span>`;
                        logsContainer.appendChild(logEntry);
                    });
                    // Auto-scroll to bottom if enabled
                    if (autoScroll) {
                        logsContainer.scrollTop = logsContainer.scrollHeight;
                    }
                }
            }
            
            // If sync is no longer running, reload the page
            if (data.status !== 'running') {
                stopAutoRefresh();
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error fetching progress:', error);
        });
}

function cancelSync() {
    if (confirm('Are you sure you want to cancel this sync operation?')) {
        fetch('{% url "plugins:netbox_meraki:sync_cancel_api" sync_log.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            alert('Cancellation requested. The sync will stop after the current operation.');
            document.getElementById('cancel-sync-btn').disabled = true;
        })
        .catch(error => {
            console.error('Error canceling sync:', error);
            alert('Failed to cancel sync: ' + error);
        });
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Start auto-refresh on page load if checkbox is checked
const checkbox = document.getElementById('auto-scroll-toggle');
if (checkbox && checkbox.checked) {
    startAutoRefresh();
}
</script>
{% else %}
<script>
// For completed syncs, add live scrolling option
let autoScroll = false;
let refreshInterval = null;

function toggleAutoScroll() {
    const checkbox = document.getElementById('auto-scroll-toggle');
    autoScroll = checkbox.checked;
    
    if (autoScroll) {
        startAutoRefresh();
    } else {
        stopAutoRefresh();
    }
}

function startAutoRefresh() {
    if (!refreshInterval) {
        refreshInterval = setInterval(fetchProgress, 2000);  // Refresh every 2 seconds
    }
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

function fetchProgress() {
    fetch('{% url "plugins:netbox_meraki:sync_progress_api" sync_log.id %}')
        .then(response => response.json())
        .then(data => {
            // Update progress logs
            if (data.progress_logs && data.progress_logs.length > 0) {
                const logsContainer = document.getElementById('progress-logs');
                if (logsContainer) {
                    const currentScrollPos = logsContainer.scrollTop;
                    const isScrolledToBottom = logsContainer.scrollHeight - logsContainer.clientHeight <= currentScrollPos + 1;
                    
                    logsContainer.innerHTML = '';
                    data.progress_logs.forEach(log => {
                        const logEntry = document.createElement('div');
                        logEntry.className = 'log-entry';
                        
                        const timestamp = log.timestamp.substring(0, 19);
                        const levelBadge = log.level === 'error' ? 
                            '<span class="badge bg-danger">ERROR</span>' :
                            log.level === 'warning' ?
                            '<span class="badge bg-warning">WARN</span>' :
                            '<span class="badge bg-info">INFO</span>';
                        
                        logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${levelBadge} <span>${log.message}</span>`;
                        logsContainer.appendChild(logEntry);
                    });
                    
                    // Auto-scroll to bottom if user was already at bottom or if auto-scroll is enabled
                    if (isScrolledToBottom || autoScroll) {
                        logsContainer.scrollTop = logsContainer.scrollHeight;
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error fetching progress:', error);
        });
}
</script>
{% endif %}
{% endblock %}
